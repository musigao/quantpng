name: Quick Build Libraries

on:
  workflow_dispatch:
    inputs:
      platforms:
        description: 'Platforms to build (选择: windows, linux, 或用逗号分隔多个)'
        required: true
        default: 'windows,linux'
        type: string

jobs:
  build:
    name: Quick Build
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: |
          x86_64-pc-windows-gnu
          x86_64-unknown-linux-gnu

    - name: Install cross-compilation tools
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-mingw-w64-x86-64 build-essential

    - name: Build Rust libraries
      run: |
        cd imagequant-sys
        
        if echo "${{ github.event.inputs.platforms }}" | grep -q "windows"; then
          echo "🏗️ Building Rust library for Windows..."
          cargo build --release --target x86_64-pc-windows-gnu
        fi
        
        if echo "${{ github.event.inputs.platforms }}" | grep -q "linux"; then
          echo "🏗️ Building Rust library for Linux..."
          cargo build --release --target x86_64-unknown-linux-gnu
        fi

    - name: Build JNA wrappers
      run: |
        cd jna-wrapper
        mkdir -p target
        
        if echo "${{ github.event.inputs.platforms }}" | grep -q "windows"; then
          echo "🔨 Building Windows DLL..."
          x86_64-w64-mingw32-gcc -std=c11 -Wall -Wextra -O3 -fPIC \
            -DBUILDING_JNA_WRAPPER \
            -Iinclude -I../imagequant-sys \
            -c src/jna_wrapper.c -o target/jna_wrapper_windows.o
          
          x86_64-w64-mingw32-gcc -shared \
            -o target/libimagequant_jna.dll \
            target/jna_wrapper_windows.o \
            ../imagequant-sys/target/x86_64-pc-windows-gnu/release/libimagequant_sys.a \
            -static-libgcc -static
        fi
        
        if echo "${{ github.event.inputs.platforms }}" | grep -q "linux"; then
          echo "🔨 Building Linux SO..."
          gcc -std=c11 -Wall -Wextra -O3 -fPIC -fvisibility=hidden \
            -DBUILDING_JNA_WRAPPER \
            -Iinclude -I../imagequant-sys \
            -c src/jna_wrapper.c -o target/jna_wrapper_linux.o
          
          echo "{ global: jna_*; local: *; };" > target/version.map
          
          gcc -shared -Wl,--version-script=target/version.map \
            -o target/libimagequant_jna.so \
            target/jna_wrapper_linux.o \
            ../imagequant-sys/target/x86_64-unknown-linux-gnu/release/libimagequant_sys.a
        fi

    - name: Upload Windows DLL
      if: contains(github.event.inputs.platforms, 'windows')
      uses: actions/upload-artifact@v4
      with:
        name: windows-dll
        path: jna-wrapper/target/libimagequant_jna.dll

    - name: Upload Linux SO
      if: contains(github.event.inputs.platforms, 'linux')
      uses: actions/upload-artifact@v4
      with:
        name: linux-so
        path: jna-wrapper/target/libimagequant_jna.so
