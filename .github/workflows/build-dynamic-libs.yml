name: Build Dynamic Libraries

on:
  push:
    branches: [ main ]
    paths:
      - 'jna-wrapper/**'
      - 'imagequant-sys/**'
      - 'src/**'
  workflow_dispatch:

jobs:
  build-libs:
    name: Build ${{ matrix.platform }} Library
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: windows
            os: windows-latest
            target: x86_64-pc-windows-msvc
            lib_name: libimagequant_jna.dll
            
          - platform: linux
            os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            lib_name: libimagequant_jna.so

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Setup MSVC (Windows)
        if: matrix.platform == 'windows'
        uses: ilammy/msvc-dev-cmd@v1

      - name: Install build tools (Linux)
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential

      - name: Build Rust static library
        run: |
          cd imagequant-sys
          cargo build --release --target ${{ matrix.target }}

      - name: Verify Rust library (Windows)
        if: matrix.platform == 'windows'
        run: |
          echo "Checking generated Rust library:"
          dir imagequant-sys\target\${{ matrix.target }}\release\
        shell: cmd

      - name: Verify Rust library (Linux)
        if: matrix.platform == 'linux'
        run: |
          echo "Checking generated Rust library:"
          ls -la imagequant-sys/target/${{ matrix.target }}/release/

      - name: Build JNA wrapper (Windows)
        if: matrix.platform == 'windows'
        run: |
          cd jna-wrapper
          if not exist target mkdir target
          
          echo Building Windows DLL with MSVC...
          
          rem ç¼–è¯‘å¯¹è±¡æ–‡ä»¶
          cl.exe /nologo /O2 /MD /W3 ^
            /D_USRDLL /D_WINDLL /DBUILDING_JNA_WRAPPER ^
            /I include /I ../imagequant-sys ^
            /c src/jna_wrapper.c /Fo:target/jna_wrapper.obj
          
          rem é“¾æŽ¥DLL - ä½¿ç”¨æ­£ç¡®çš„é™æ€åº“åç§°å’Œè·¯å¾„
          link.exe /nologo /DLL /OUT:target/${{ matrix.lib_name }} ^
            target/jna_wrapper.obj ^
            ..\imagequant-sys\target\${{ matrix.target }}\release\imagequant_sys.lib ^
            ws2_32.lib advapi32.lib userenv.lib
        shell: cmd

      - name: Build JNA wrapper (Linux)
        if: matrix.platform == 'linux'
        run: |
          cd jna-wrapper
          mkdir -p target
          
          echo "Building Linux SO..."
          
          # ç¼–è¯‘å¯¹è±¡æ–‡ä»¶
          gcc -std=c11 -Wall -Wextra -O3 -fPIC -fvisibility=hidden \
            -DBUILDING_JNA_WRAPPER \
            -Iinclude -I../imagequant-sys \
            -c src/jna_wrapper.c -o target/jna_wrapper.o
          
          # åˆ›å»ºç‰ˆæœ¬è„šæœ¬æ¥æŽ§åˆ¶ç¬¦å·å¯¼å‡º
          cat > target/version.map << 'EOF'
          { 
            global: jna_*; 
            local: *; 
          };
          EOF
          
          # é“¾æŽ¥å…±äº«åº“ - ä½¿ç”¨æ­£ç¡®çš„é™æ€åº“åç§°ï¼Œæ·»åŠ æ•°å­¦åº“
          gcc -shared -Wl,--version-script=target/version.map \
            -o target/${{ matrix.lib_name }} \
            target/jna_wrapper.o \
            ../target/${{ matrix.target }}/release/libimagequant_sys.a \
            -lm -lpthread -ldl

      - name: Verify library (Windows)
        if: matrix.platform == 'windows'
        run: |
          cd jna-wrapper/target
          echo "Generated library file:"
          dir ${{ matrix.lib_name }}
        shell: cmd

      - name: Verify library (Linux)
        if: matrix.platform == 'linux'
        run: |
          cd jna-wrapper/target
          echo "Generated library file:"
          ls -la ${{ matrix.lib_name }}
          
          echo "Library info:"
          file ${{ matrix.lib_name }}
          echo "Dependencies:"
          ldd ${{ matrix.lib_name }} || echo "Static linking check complete"
          echo "Exported symbols:"
          nm -D ${{ matrix.lib_name }} | grep jna_ || echo "No jna_ symbols found"

      - name: Test library loading (Linux)
        if: matrix.platform == 'linux'
        run: |
          cd jna-wrapper
          
          # åˆ›å»ºç®€å•çš„æµ‹è¯•ç¨‹åº
          cat > test_load.c << 'EOF'
          #include <dlfcn.h>
          #include <stdio.h>
          
          int main() {
              void *handle = dlopen("./target/libimagequant_jna.so", RTLD_LAZY);
              if (!handle) {
                  printf("Error loading library: %s\n", dlerror());
                  return 1;
              }
              
              // æŸ¥æ‰¾ä¸€ä¸ªå‡½æ•°
              void *func = dlsym(handle, "jna_liq_attr_create");
              if (!func) {
                  printf("Error finding function: %s\n", dlerror());
                  dlclose(handle);
                  return 1;
              }
              
              printf("Library loaded successfully!\n");
              dlclose(handle);
              return 0;
          }
          EOF
          
          # ç¼–è¯‘å¹¶è¿è¡Œæµ‹è¯•
          gcc -o test_load test_load.c -ldl
          ./test_load

      - name: Upload library
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform }}-library
          path: jna-wrapper/target/${{ matrix.lib_name }}
          retention-days: 30

  package-release:
    name: Package Libraries
    needs: build-libs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all libraries
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create release package
        run: |
          mkdir -p release-package/libs
          mkdir -p release-package/java
          mkdir -p release-package/docs
          
          # å¤åˆ¶åº“æ–‡ä»¶
          find artifacts -name "*.dll" -exec cp {} release-package/libs/ \;
          find artifacts -name "*.so" -exec cp {} release-package/libs/ \;
          
          # å¤åˆ¶JNAåº“å’ŒJavaä»£ç 
          cp jna-wrapper/lib/jna-5.13.0.jar release-package/java/
          cp -r jna-wrapper/java/* release-package/java/ 2>/dev/null || true
          
          # å¤åˆ¶å¤´æ–‡ä»¶
          cp jna-wrapper/include/jna_wrapper.h release-package/docs/
          cp imagequant-sys/libimagequant.h release-package/docs/
          
          # åˆ›å»ºä½¿ç”¨è¯´æ˜Ž
          cat > release-package/README.md << 'EOF'
          # ImageQuant JNA åŠ¨æ€åº“åŒ…
          
          ## æ–‡ä»¶è¯´æ˜Ž
          
          - `libs/libimagequant_jna.dll` - Windows 64ä½åŠ¨æ€åº“
          - `libs/libimagequant_jna.so` - Linux 64ä½åŠ¨æ€åº“
          - `java/jna-5.13.0.jar` - JNAåº“
          - `java/` - JavaåŒ…è£…ç±»
          - `docs/` - Cå¤´æ–‡ä»¶
          
          ## å¿«é€Ÿä½¿ç”¨
          
          ### 1. Javaé¡¹ç›®é›†æˆ
          ```bash
          # å°†åº“æ–‡ä»¶æ”¾åœ¨é¡¹ç›®æ ¹ç›®å½•æˆ–æŒ‡å®šè·¯å¾„
          java -Djava.library.path=./libs -cp jna-5.13.0.jar:. YourApp
          ```
          
          ### 2. ä»£ç ç¤ºä¾‹
          ```java
          import org.pngquant.jna.PngCompressor;
          
          PngCompressor compressor = new PngCompressor();
          boolean success = compressor.compress("input.png", "output.png", 80, 256, 3);
          ```
          
          ## æŠ€æœ¯ç‰¹ç‚¹
          
          - âœ… ä¿®å¤äº†64ä½æŒ‡é’ˆç±»åž‹è½¬æ¢é—®é¢˜
          - âœ… é™æ€é“¾æŽ¥ï¼Œå‡å°‘ä¾èµ–
          - âœ… é«˜è´¨é‡PNGåŽ‹ç¼©
          - âœ… è·¨å¹³å°æ”¯æŒ
          
          æž„å»ºæ—¶é—´: $(date)
          EOF
          
          # æ˜¾ç¤ºåŒ…å†…å®¹
          echo "Package contents:"
          find release-package -type f | sort
          
          # åˆ›å»ºåŽ‹ç¼©åŒ…
          tar -czf libimagequant-jna-libs.tar.gz -C release-package .

      - name: Upload complete package
        uses: actions/upload-artifact@v4
        with:
          name: libimagequant-jna-complete
          path: |
            release-package/
            libimagequant-jna-libs.tar.gz
          retention-days: 90

      - name: Build summary
        run: |
          echo ""
          echo "ðŸŽ‰ æž„å»ºå®Œæˆï¼"
          echo ""
          echo "ðŸ“¦ ç”Ÿæˆçš„åº“æ–‡ä»¶:"
          find artifacts -name "*.dll" -o -name "*.so" | while read file; do
            echo "  âœ… $(basename "$file")"
          done
          echo ""
          echo "ðŸ“‹ ä¸‹è½½æ–¹å¼:"
          echo "  1. ç‚¹å‡» GitHub Actions ä¸­çš„æž„å»ºç»“æžœ"
          echo "  2. åœ¨ Artifacts éƒ¨åˆ†ä¸‹è½½å¯¹åº”çš„åº“æ–‡ä»¶"
          echo "  3. æˆ–ä¸‹è½½å®Œæ•´åŒ… 'libimagequant-jna-complete'"
          echo ""
          echo "ðŸš€ å¼€å§‹ä½¿ç”¨å§ï¼"
