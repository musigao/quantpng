name: Quick Build Libraries

on:
  workflow_dispatch:
    inputs:
      platforms:
        description: 'Platforms to build (é€‰æ‹©: windows, linux, macos, æˆ–ç”¨é€—å·åˆ†éš”å¤šä¸ª)'
        required: true
        default: 'windows,linux'
        type: string

jobs:
  build:
    name: Quick Build
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: |
          x86_64-pc-windows-gnu
          x86_64-unknown-linux-gnu

    - name: Install cross-compilation tools
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-mingw-w64-x86-64 build-essential

    - name: Build Rust libraries
      run: |
        cd imagequant-sys
        
        # Build for Windows
        if echo "${{ github.event.inputs.platforms }}" | grep -q "windows"; then
          echo "ðŸ—ï¸ Building Rust library for Windows..."
          cargo build --release --target x86_64-pc-windows-gnu
        fi
        
        # Build for Linux
        if echo "${{ github.event.inputs.platforms }}" | grep -q "linux"; then
          echo "ðŸ—ï¸ Building Rust library for Linux..."
          cargo build --release --target x86_64-unknown-linux-gnu
        fi

    - name: Build JNA wrappers
      run: |
        cd jna-wrapper
        mkdir -p target
        
        # Build Windows DLL
        if echo "${{ github.event.inputs.platforms }}" | grep -q "windows"; then
          echo "ðŸ”¨ Building Windows DLL..."
          x86_64-w64-mingw32-gcc -std=c11 -Wall -Wextra -O3 -fPIC \
            -DBUILDING_JNA_WRAPPER \
            -Iinclude -I../imagequant-sys \
            -c src/jna_wrapper.c -o target/jna_wrapper_windows.o
          
          x86_64-w64-mingw32-gcc -shared \
            -o target/libimagequant_jna.dll \
            target/jna_wrapper_windows.o \
            ../imagequant-sys/target/x86_64-pc-windows-gnu/release/libimagequant_sys.a \
            -static-libgcc -static
        fi
        
        # Build Linux SO
        if echo "${{ github.event.inputs.platforms }}" | grep -q "linux"; then
          echo "ðŸ”¨ Building Linux SO..."
          gcc -std=c11 -Wall -Wextra -O3 -fPIC -fvisibility=hidden \
            -DBUILDING_JNA_WRAPPER \
            -Iinclude -I../imagequant-sys \
            -c src/jna_wrapper.c -o target/jna_wrapper_linux.o
          
          # Create version script
          echo "{ global: jna_*; local: *; };" > target/version.map
          
          gcc -shared -Wl,--version-script=target/version.map \
            -o target/libimagequant_jna.so \
            target/jna_wrapper_linux.o \
            ../imagequant-sys/target/x86_64-unknown-linux-gnu/release/libimagequant_sys.a
        fi

    - name: Test and verify libraries
      run: |
        cd jna-wrapper/target
        
        echo "ðŸ“‹ Generated files:"
        ls -la
        
        # Check file types and sizes
        for lib in *.dll *.so; do
          if [ -f "$lib" ]; then
            echo ""
            echo "ðŸ“„ File info for $lib:"
            file "$lib"
            echo "ðŸ“¦ Size: $(du -h "$lib" | cut -f1)"
            
            # Check dependencies
            if [[ "$lib" == *.so ]]; then
              echo "ðŸ”— Dependencies:"
              ldd "$lib" || echo "Static linking detected"
            fi
          fi
        done

    - name: Create usage package
      run: |
        mkdir -p quick-build-package/libs
        mkdir -p quick-build-package/java-example
        
        # Copy generated libraries
        if [ -f "jna-wrapper/target/libimagequant_jna.dll" ]; then
          cp jna-wrapper/target/libimagequant_jna.dll quick-build-package/libs/
        fi
        
        if [ -f "jna-wrapper/target/libimagequant_jna.so" ]; then
          cp jna-wrapper/target/libimagequant_jna.so quick-build-package/libs/
        fi
        
        # Copy existing macOS dylib if available
        if [ -f "jna-wrapper/target/libimagequant_jna.dylib" ]; then
          cp jna-wrapper/target/libimagequant_jna.dylib quick-build-package/libs/
        fi
        
        # Copy JNA library
        cp jna-wrapper/lib/jna-5.13.0.jar quick-build-package/java-example/
        
        # Create simple usage example
        cat > quick-build-package/java-example/QuickTest.java << 'EOF'
import com.sun.jna.Library;
import com.sun.jna.Native;
import com.sun.jna.Platform;

public interface ImageQuantLibrary extends Library {
    // æ ¹æ®å¹³å°åŠ è½½ç›¸åº”çš„åº“
    ImageQuantLibrary INSTANCE = (ImageQuantLibrary) Native.load(
        Platform.isWindows() ? "libimagequant_jna" :
        Platform.isLinux() ? "libimagequant_jna" : 
        "libimagequant_jna", ImageQuantLibrary.class);
    
    // å£°æ˜Žä¸€äº›åŸºæœ¬çš„JNAå‡½æ•°
    long jna_liq_attr_create();
    void jna_liq_attr_destroy(long attr);
}

public class QuickTest {
    public static void main(String[] args) {
        try {
            System.out.println("ðŸ§ª Testing ImageQuant JNA library loading...");
            
            // å°è¯•åˆ›å»ºå±žæ€§å¯¹è±¡
            long attr = ImageQuantLibrary.INSTANCE.jna_liq_attr_create();
            if (attr != 0) {
                System.out.println("âœ… Library loaded successfully!");
                System.out.println("ðŸ“Š Created liq_attr: " + attr);
                
                // æ¸…ç†
                ImageQuantLibrary.INSTANCE.jna_liq_attr_destroy(attr);
                System.out.println("ðŸ§¹ Cleaned up successfully");
            } else {
                System.out.println("âŒ Failed to create liq_attr");
            }
        } catch (Exception e) {
            System.out.println("âŒ Error: " + e.getMessage());
            e.printStackTrace();
        }
    }
}
EOF
        
        # Create usage instructions
        cat > quick-build-package/README.md << 'EOF'
# ImageQuant JNA å¿«é€Ÿæž„å»ºåŒ…

ðŸŽ‰ è¿™ä¸ªåŒ…åŒ…å«äº†æ–°æž„å»ºçš„ ImageQuant JNA åº“æ–‡ä»¶ï¼

## ðŸ“ æ–‡ä»¶ç»“æž„

```
libs/
  â”œâ”€â”€ libimagequant_jna.dll     # Windows 64ä½ (å¦‚æžœæž„å»ºäº†)
  â”œâ”€â”€ libimagequant_jna.so      # Linux 64ä½ (å¦‚æžœæž„å»ºäº†)
  â””â”€â”€ libimagequant_jna.dylib   # macOS 64ä½ (å¦‚æžœå­˜åœ¨)

java-example/
  â”œâ”€â”€ QuickTest.java            # ç®€å•æµ‹è¯•ç¤ºä¾‹
  â””â”€â”€ jna-5.13.0.jar            # JNA åº“
```

## ðŸš€ å¿«é€Ÿæµ‹è¯•

1. **å‡†å¤‡çŽ¯å¢ƒ**
   ```bash
   cd quick-build-package/java-example
   ```

2. **ç¼–è¯‘æµ‹è¯•ç¨‹åº**
   ```bash
   javac -cp jna-5.13.0.jar QuickTest.java
   ```

3. **è¿è¡Œæµ‹è¯•** (æ ¹æ®ä½ çš„å¹³å°é€‰æ‹©)
   ```bash
   # Linux
   java -Djava.library.path=../libs -cp jna-5.13.0.jar:. QuickTest
   
   # Windows
   java -Djava.library.path=../libs -cp jna-5.13.0.jar;. QuickTest
   
   # macOS
   java -Djava.library.path=../libs -cp jna-5.13.0.jar:. QuickTest
   ```

## ðŸ’¡ åœ¨ä½ çš„é¡¹ç›®ä¸­ä½¿ç”¨

1. å°†å¯¹åº”å¹³å°çš„åº“æ–‡ä»¶å¤åˆ¶åˆ°ä½ çš„é¡¹ç›®ä¸­
2. ç¡®ä¿ JNA åº“åœ¨ classpath ä¸­
3. è®¾ç½® `java.library.path` æŒ‡å‘åº“æ–‡ä»¶ä½ç½®
4. ä½¿ç”¨ PngCompressor ç±»è¿›è¡Œå›¾åƒåŽ‹ç¼©

## ðŸ”§ å·²ä¿®å¤çš„é—®é¢˜

- âœ… é¢œè‰²é€šé“é¡ºåº (ä¸å†å‡ºçŽ°ç²‰è‰²é—®é¢˜)
- âœ… è·¨å¹³å°åº“åŠ è½½
- âœ… å†…å­˜ç®¡ç†
- âœ… é™æ€é“¾æŽ¥ä¾èµ–

## ðŸ“ æž„å»ºä¿¡æ¯

- æž„å»ºæ—¶é—´: $(date)
- Git æäº¤: ${GITHUB_SHA:0:8}
EOF
        
        echo ""
        echo "ðŸ“¦ Package contents:"
        find quick-build-package -type f | sort

    - name: Upload Windows DLL
      if: contains(github.event.inputs.platforms, 'windows')
      uses: actions/upload-artifact@v4
      with:
        name: windows-dll
        path: jna-wrapper/target/libimagequant_jna.dll
        retention-days: 7

    - name: Upload Linux SO
      if: contains(github.event.inputs.platforms, 'linux')
      uses: actions/upload-artifact@v4
      with:
        name: linux-so
        path: jna-wrapper/target/libimagequant_jna.so
        retention-days: 7

    - name: Upload complete package
      uses: actions/upload-artifact@v4
      with:
        name: imagequant-jna-quick-build
        path: quick-build-package/
        retention-days: 30

    - name: Summary
      run: |
        echo ""
        echo "ðŸŽŠ å¿«é€Ÿæž„å»ºå®Œæˆ!"
        echo ""
        echo "ðŸ“‹ æž„å»ºçš„å¹³å°: ${{ github.event.inputs.platforms }}"
        echo "ðŸ“ ç”Ÿæˆçš„æ–‡ä»¶:"
        find jna-wrapper/target -name "*.dll" -o -name "*.so" -o -name "*.dylib" | while read file; do
          echo "  âœ… $(basename "$file") ($(du -h "$file" | cut -f1))"
        done
        echo ""
        echo "ðŸ“¦ ä¸‹è½½æ–¹å¼:"
        echo "  1. åœ¨ GitHub Actions é¡µé¢ç‚¹å‡»è¿™ä¸ªæž„å»º"
        echo "  2. åœ¨ 'Artifacts' éƒ¨åˆ†ä¸‹è½½æ–‡ä»¶"
        echo "  3. æˆ–ä¸‹è½½å®Œæ•´çš„ 'imagequant-jna-quick-build' åŒ…"
        echo ""
        echo "ðŸš€ å¼€å§‹ä½¿ç”¨åº“æ–‡ä»¶å§!"
